{% extends 'base.html' %}

{% block title %}Sign Registration Card - Smart Hotel{% endblock %}

{% block head %}
<style>
.sign-page {
    max-width: 900px;
    margin: 0 auto;
}
.sign-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border);
}
.sign-header .icon-box {
    flex-shrink: 0;
}
.sign-header h1 {
    margin-bottom: 0.25rem;
    font-size: 1.5rem;
}
.sign-header p {
    margin: 0;
    color: var(--text-muted);
}

/* Document Preview Styles */
.document-preview {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 2rem;
    margin-bottom: 2rem;
    max-height: 400px;
    overflow-y: auto;
}
.document-preview .registration-card {
    font-family: 'Arial', sans-serif;
    color: #333;
}
.document-preview .header {
    text-align: center;
    border-bottom: 2px solid #333;
    padding-bottom: 15px;
    margin-bottom: 20px;
}
.document-preview .header h1 {
    margin: 0;
    font-size: 1.5rem;
    color: #1a1a1a;
}
.document-preview .header .subtitle {
    color: #666;
    font-size: 0.9rem;
}
.document-preview .section {
    margin-bottom: 1.5rem;
}
.document-preview .section h3 {
    font-size: 1rem;
    border-bottom: 1px solid #ccc;
    padding-bottom: 5px;
    margin-bottom: 10px;
    color: var(--brand);
}
.document-preview .field-row {
    display: flex;
    gap: 20px;
    margin-bottom: 8px;
    flex-wrap: wrap;
}
.document-preview .field {
    flex: 1;
    min-width: 200px;
}
.document-preview .field label {
    font-weight: bold;
    color: #555;
    font-size: 0.85rem;
}
.document-preview .field .value {
    color: #333;
}
.document-preview .accompanying-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}
.document-preview .accompanying-table th,
.document-preview .accompanying-table td {
    border: 1px solid #ccc;
    padding: 6px 10px;
    text-align: left;
}
.document-preview .accompanying-table th {
    background: #f5f5f5;
}
.document-preview .signature-section {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px dashed var(--border);
}
.document-preview .signature-line {
    width: 250px;
    height: 60px;
    border-bottom: 2px solid #333;
    margin: 15px 0;
}
.document-preview .signature-image {
    max-width: 250px;
    max-height: 80px;
    display: block;
}
.document-preview .signature-note {
    font-size: 0.85rem;
    color: #666;
    font-style: italic;
}

/* Signature Canvas Styles */
.signature-container {
    background: var(--bg);
    border-radius: var(--radius);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}
.signature-container h4 {
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.signature-canvas-wrapper {
    position: relative;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: #fff;
    overflow: hidden;
}
#signatureCanvas {
    display: block;
    width: 100%;
    height: 200px;
    cursor: crosshair;
    touch-action: none;
}
.signature-canvas-wrapper.signing {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(201, 169, 98, 0.2);
}
.signature-placeholder {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--text-muted);
    pointer-events: none;
    font-size: 1.1rem;
    text-align: center;
}
.signature-placeholder.hidden {
    display: none;
}
.signature-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
}

/* Print Area Styles */
.print-container {
    background: var(--bg);
    border-radius: var(--radius);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    text-align: center;
}
.print-container .icon-box {
    margin: 0 auto 1rem;
}
.print-container p {
    margin-bottom: 1rem;
    color: var(--text-muted);
}

/* Action Buttons */
.action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
}
.action-buttons .btn {
    flex: 1;
    min-width: 200px;
}

/* Tabs for signature method */
.method-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 1.5rem;
    border-radius: var(--radius);
    overflow: hidden;
    border: 1px solid var(--border);
}
.method-tab {
    flex: 1;
    padding: 1rem;
    background: var(--bg);
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-weight: 500;
}
.method-tab:not(:last-child) {
    border-right: 1px solid var(--border);
}
.method-tab.active {
    background: var(--accent);
    color: #fff;
}
.method-tab:hover:not(.active) {
    background: rgba(201, 169, 98, 0.1);
}
.method-content {
    display: none;
}
.method-content.active {
    display: block;
}
</style>
{% endblock %}

{% block content %}
<div class="sign-page">
    <div class="card p-4 p-md-5">
        <div class="sign-header">
            <div class="icon-box icon-brand">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/></svg>
            </div>
            <div>
                <h1 data-i18n="sign_registration_card">Sign Registration Card</h1>
                {% if reservation %}
                <p>Reservation: <strong>{{ reservation.reservation_number }}</strong></p>
                {% else %}
                <p data-i18n="review_and_sign">Review your information and sign to complete</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Document Preview -->
        <div class="document-preview" id="documentPreview">
            {{ document_preview|safe }}
        </div>
        
        <!-- Signature Method Tabs -->
        <div class="method-tabs">
            <button type="button" class="method-tab {% if signature_method == 'digital' %}active{% endif %}" data-method="digital">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3z"/><path d="M13.5 6.207 9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5z"/><path fill-rule="evenodd" d="m6.032 13.675-.179.178a.5.5 0 0 1-.11.168l-2 5a.5.5 0 1 1-.65-.65l5-2a.5.5 0 0 1 .168-.11l.178-.178z"/></svg>
                <span data-i18n="digital_signature">Digital Signature</span>
            </button>
            <button type="button" class="method-tab {% if signature_method == 'physical' %}active{% endif %}" data-method="physical">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/><path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5z"/></svg>
                <span data-i18n="print_sign">Print & Sign</span>
            </button>
        </div>
        
        <!-- Digital Signature Content -->
        <div class="method-content {% if signature_method == 'digital' %}active{% endif %}" id="digitalContent">
            <div class="signature-container">
                <h4>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3z"/><path d="M13.5 6.207 9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5z"/></svg>
                    <span data-i18n="draw_signature">Draw Your Signature</span>
                </h4>
                <div class="signature-canvas-wrapper" id="canvasWrapper">
                    <canvas id="signatureCanvas"></canvas>
                    <div class="signature-placeholder" id="signaturePlaceholder">
                        ✍️ Sign here with your finger or mouse
                    </div>
                </div>
                <div class="signature-actions">
                    <button type="button" class="btn btn-outline-secondary" id="clearSignature">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5z"/></svg>
                        <span data-i18n="clear">Clear</span>
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="undoSignature">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="me-1" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/></svg>
                        <span data-i18n="undo">Undo</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Print & Sign Content -->
        <div class="method-content {% if signature_method == 'physical' %}active{% endif %}" id="physicalContent">
            <div class="print-container">
                <div class="icon-box icon-box-lg icon-brand">
                    <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="currentColor" viewBox="0 0 16 16"><path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/><path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1z"/></svg>
                </div>
                <p data-i18n="print_instruction">Print the registration card and sign it with a pen. Then confirm below to continue.</p>
                <a href="{% url 'kiosk:dw_generate_pdf' %}" target="_blank" class="btn btn-outline-primary btn-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-2" viewBox="0 0 16 16"><path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/><path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5z"/></svg>
                    <span data-i18n="print_document">Print Document</span>
                </a>
            </div>
        </div>
        
        <!-- Submit Form -->
        <form method="post" id="signForm">
            {% csrf_token %}
            <input type="hidden" name="signature_data" id="signatureData" value="">
            
            <div class="action-buttons">
                <a href="{% url 'kiosk:dw_registration_card' %}" class="btn btn-outline-secondary btn-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-2" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg>
                    <span data-i18n="back_to_edit">Back to Edit</span>
                </a>
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="me-2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/></svg>
                    <span data-i18n="confirm_continue">Confirm & Continue</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Method tab switching
    const methodTabs = document.querySelectorAll('.method-tab');
    const methodContents = document.querySelectorAll('.method-content');
    
    methodTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const method = this.dataset.method;
            
            methodTabs.forEach(t => t.classList.remove('active'));
            methodContents.forEach(c => c.classList.remove('active'));
            
            this.classList.add('active');
            document.getElementById(method + 'Content').classList.add('active');
        });
    });
    
    // Signature Canvas
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    const wrapper = document.getElementById('canvasWrapper');
    const placeholder = document.getElementById('signaturePlaceholder');
    const signatureDataInput = document.getElementById('signatureData');
    
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    let hasSignature = false;
    let paths = [];
    let currentPath = [];
    
    // Set canvas size
    function resizeCanvas() {
        const rect = wrapper.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        canvas.width = rect.width * dpr;
        canvas.height = 200 * dpr;
        canvas.style.width = rect.width + 'px';
        canvas.style.height = '200px';
        ctx.scale(dpr, dpr);
        ctx.strokeStyle = '#1a1a1a';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        redrawPaths();
    }
    
    function redrawPaths() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        paths.forEach(path => {
            if (path.length > 0) {
                ctx.beginPath();
                ctx.moveTo(path[0].x, path[0].y);
                path.forEach(point => {
                    ctx.lineTo(point.x, point.y);
                });
                ctx.stroke();
            }
        });
    }
    
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    function getCoordinates(e) {
        const rect = canvas.getBoundingClientRect();
        if (e.touches) {
            return {
                x: e.touches[0].clientX - rect.left,
                y: e.touches[0].clientY - rect.top
            };
        }
        return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
        };
    }
    
    function startDrawing(e) {
        e.preventDefault();
        isDrawing = true;
        wrapper.classList.add('signing');
        placeholder.classList.add('hidden');
        hasSignature = true;
        
        const coords = getCoordinates(e);
        lastX = coords.x;
        lastY = coords.y;
        currentPath = [{ x: lastX, y: lastY }];
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
    }
    
    function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();
        
        const coords = getCoordinates(e);
        ctx.lineTo(coords.x, coords.y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(coords.x, coords.y);
        
        currentPath.push({ x: coords.x, y: coords.y });
        lastX = coords.x;
        lastY = coords.y;
    }
    
    function stopDrawing(e) {
        if (isDrawing && currentPath.length > 0) {
            paths.push(currentPath);
        }
        isDrawing = false;
        wrapper.classList.remove('signing');
        currentPath = [];
        updateSignatureData();
    }
    
    function updateSignatureData() {
        if (hasSignature) {
            signatureDataInput.value = canvas.toDataURL('image/png');
        }
    }
    
    // Mouse events
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    // Touch events
    canvas.addEventListener('touchstart', startDrawing);
    canvas.addEventListener('touchmove', draw);
    canvas.addEventListener('touchend', stopDrawing);
    canvas.addEventListener('touchcancel', stopDrawing);
    
    // Clear button
    document.getElementById('clearSignature').addEventListener('click', function() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        paths = [];
        hasSignature = false;
        placeholder.classList.remove('hidden');
        signatureDataInput.value = '';
    });
    
    // Undo button
    document.getElementById('undoSignature').addEventListener('click', function() {
        if (paths.length > 0) {
            paths.pop();
            redrawPaths();
            updateSignatureData();
            
            if (paths.length === 0) {
                hasSignature = false;
                placeholder.classList.remove('hidden');
                signatureDataInput.value = '';
            }
        }
    });
    
    // Form submission
    document.getElementById('signForm').addEventListener('submit', function(e) {
        const activeMethod = document.querySelector('.method-tab.active').dataset.method;
        
        if (activeMethod === 'digital' && !hasSignature) {
            e.preventDefault();
            alert('Please draw your signature before continuing.');
            return;
        }
        
        updateSignatureData();
    });
});
</script>
{% endblock %}
